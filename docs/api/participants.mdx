import { Users, ClipboardList, User, Key, BarChart3, AlertTriangle, Lightbulb, BookOpen, CheckCircle } from 'lucide-react';

# Spr√°va √∫ƒçastn√≠k≈Ø (Participants)

## P≈ôehled

API pro spr√°vu √∫ƒçastn√≠k≈Ø umo≈æ≈àuje spravovat vztahy mezi u≈æivateli a spoleƒçnostmi vƒçetnƒõ jejich rol√≠ a opr√°vnƒõn√≠. Participant je z√°znam, kter√Ω propojuje konkr√©tn√≠ho u≈æivatele se spoleƒçnost√≠ a definuje jeho opr√°vnƒõn√≠ v r√°mci t√©to spoleƒçnosti.

### Hlavn√≠ funkce
- Z√≠sk√°n√≠ seznamu √∫ƒçastn√≠k≈Ø pro u≈æivatele
- Zobrazen√≠ detail≈Ø konkr√©tn√≠ho √∫ƒçastn√≠ka
- Spr√°va opr√°vnƒõn√≠ a rol√≠
- P≈ôi≈ôazen√≠ u≈æivatel≈Ø ke spoleƒçnostem

### Koncept √∫ƒçastn√≠ka
**Participant** = spojen√≠ mezi:
- **User** (u≈æivatel) - fyzick√° osoba s p≈ôihla≈°ovac√≠mi √∫daji
- **Company** (spoleƒçnost) - organizace vlastn√≠c√≠ za≈ô√≠zen√≠
- **Permissions** (opr√°vnƒõn√≠) - seznam pr√°v v r√°mci spoleƒçnosti

### Use cases
- **Multi-company p≈ô√≠stup** - jeden u≈æivatel m≈Ø≈æe m√≠t p≈ô√≠stup k v√≠ce spoleƒçnostem
- **Role-based access** - r≈Øzn√© √∫rovnƒõ opr√°vnƒõn√≠ pro r≈Øzn√© u≈æivatele
- **Delegov√°n√≠ spr√°vy** - vlastn√≠k m≈Ø≈æe p≈ôidƒõlit pr√°va dal≈°√≠m u≈æivatel≈Øm
- **Audit p≈ô√≠stup≈Ø** - sledov√°n√≠ kdo m√° jak√° opr√°vnƒõn√≠

---

## <ClipboardList size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Seznam √∫ƒçastn√≠k≈Ø u≈æivatele

### Endpoint
```
GET /admin-panel/v1/external/user/{id}/participant
```

### Parametry

#### Path parametry
| Parametr | Typ | Povinn√Ω | Popis |
|----------|-----|---------|-------|
| `id` | number | <CheckCircle size={16} style={{display: 'inline', verticalAlign: 'middle'}} color="var(--ifm-color-success)" /> | ID u≈æivatele |

### Response
```json
{
  "status": 1,
  "data": [
    {
      "id": 9876543210987654,
      "email": "jan.novak@example.com",
      "phone_number": "+420123456789",
      "user": {
        "id": 1234567890123456,
        "first_name": "Jan",
        "last_name": "Nov√°k",
        "email": "jan.novak@example.com"
      },
      "company": {
        "id": 5555555555555555,
        "name": "Example Company s.r.o.",
        "ico": "12345678",
        "dic": "CZ12345678",
        "address": {
          "street": "Hlavn√≠ 123",
          "city": "Praha",
          "postal_code": "11000",
          "country": "CZ"
        }
      },
      "permissions": [
        {
          "id": 1111111111111111,
          "slug": "view_monitoring",
          "name": "View Monitoring",
          "description": "Can view monitoring data",
          "category": "monitoring"
        },
        {
          "id": 2222222222222222,
          "slug": "manage_devices",
          "name": "Manage Devices",
          "description": "Can manage device settings",
          "category": "devices"
        },
        {
          "id": 3333333333333333,
          "slug": "view_reports",
          "name": "View Reports",
          "description": "Can view charging reports",
          "category": "reports"
        }
      ],
      "role": {
        "id": 7777777777777777,
        "name": "Device Manager",
        "slug": "device_manager",
        "description": "Can manage devices and view reports",
        "is_system": false
      },
      "status": "active",
      "created_at": "2024-01-15T10:30:00Z",
      "created_by": {
        "id": 8888888888888888,
        "name": "Admin User",
        "email": "admin@example.com"
      },
      "updated_at": "2024-03-20T14:25:00Z",
      "expires_at": null,
      "metadata": {
        "department": "Technical",
        "employee_id": "EMP001",
        "cost_center": "IT-001"
      }
    }
  ]
}
```

### Struktura dat

#### Participant objekt
| Pole | Typ | Popis |
|------|-----|-------|
| `id` | number | Unik√°tn√≠ identifik√°tor √∫ƒçastn√≠ka |
| `email` | string | E-mail √∫ƒçastn√≠ka (m≈Ø≈æe se li≈°it od user.email) |
| `phone_number` | string/null | Telefonn√≠ ƒç√≠slo |
| `user` | object | Reference na u≈æivatele |
| `company` | object | Reference na spoleƒçnost |
| `permissions` | array | Seznam opr√°vnƒõn√≠ |
| `role` | object | P≈ôi≈ôazen√° role |
| `status` | string | Status (`active`, `suspended`, `pending`) |
| `created_at` | string | Datum vytvo≈ôen√≠ |
| `expires_at` | string/null | Datum expirace p≈ô√≠stupu |

### P≈ô√≠klad vol√°n√≠

#### cURL
```bash
curl -X GET "https://cloud.mybox.pro/admin-panel/v1/external/user/1234567890123456/participant" \
  -u "YOUR_API_KEY:YOUR_API_SECRET" \
  -H "Accept: application/json"
```

#### Python
```python
import requests
from requests.auth import HTTPBasicAuth

def get_user_participants(user_id):
    """Z√≠sk√° seznam √∫ƒçastn√≠k≈Ø pro u≈æivatele"""

    url = f"https://cloud.mybox.pro/admin-panel/v1/external/user/{user_id}/participant"

    response = requests.get(
        url,
        auth=HTTPBasicAuth('YOUR_API_KEY', 'YOUR_API_SECRET'),
        headers={'Accept': 'application/json'}
    )

    if response.status_code == 200:
        participants = response.json()['data']

        for participant in participants:
            print(f"\n√öƒçastn√≠k: {participant['email']}")
            print(f"Spoleƒçnost: {participant['company']['name']}")
            print(f"Role: {participant.get('role', {}).get('name', 'Bez role')}")
            print(f"Status: {participant['status']}")

            print("Opr√°vnƒõn√≠:")
            for perm in participant['permissions']:
                print(f"  - {perm['name']} ({perm['slug']})")
    else:
        print(f"Chyba: {response.status_code}")

# Pou≈æit√≠
get_user_participants(1234567890123456)
```

#### JavaScript/Node.js
```javascript
const axios = require('axios');

async function getUserParticipants(userId) {
  try {
    const response = await axios.get(
      `https://cloud.mybox.pro/admin-panel/v1/external/user/${userId}/participant`,
      {
        auth: {
          username: 'YOUR_API_KEY',
          password: 'YOUR_API_SECRET'
        },
        headers: {
          'Accept': 'application/json'
        }
      }
    );

    const participants = response.data.data;

    participants.forEach(participant => {
      console.log(`\n√öƒçastn√≠k: ${participant.email}`);
      console.log(`Spoleƒçnost: ${participant.company.name}`);
      console.log(`Status: ${participant.status}`);

      // Zobrazit opr√°vnƒõn√≠ podle kategorie
      const permsByCategory = {};
      participant.permissions.forEach(perm => {
        const category = perm.category || 'other';
        if (!permsByCategory[category]) {
          permsByCategory[category] = [];
        }
        permsByCategory[category].push(perm.name);
      });

      console.log('Opr√°vnƒõn√≠ po kategori√≠ch:');
      Object.entries(permsByCategory).forEach(([category, perms]) => {
        console.log(`  ${category}: ${perms.join(', ')}`);
      });
    });
  } catch (error) {
    console.error('Error:', error.message);
  }
}

// Pou≈æit√≠
getUserParticipants(1234567890123456);
```

---

## <User size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Detail √∫ƒçastn√≠ka

### Endpoint
```
GET /admin-panel/v1/external/user/{id}/participant/{participantId}
```

### Parametry

#### Path parametry
| Parametr | Typ | Povinn√Ω | Popis |
|----------|-----|---------|-------|
| `id` | number | <CheckCircle size={16} style={{display: 'inline', verticalAlign: 'middle'}} color="var(--ifm-color-success)" /> | ID u≈æivatele |
| `participantId` | number | <CheckCircle size={16} style={{display: 'inline', verticalAlign: 'middle'}} color="var(--ifm-color-success)" /> | ID √∫ƒçastn√≠ka |

### Response
```json
{
  "status": 1,
  "data": {
    "id": 9876543210987654,
    "email": "jan.novak@example.com",
    "phone_number": "+420123456789",
    "user": {
      "id": 1234567890123456,
      "first_name": "Jan",
      "last_name": "Nov√°k",
      "email": "jan.novak@example.com",
      "status": "active",
      "last_login": "2024-03-25T09:15:00Z",
      "login_count": 42
    },
    "company": {
      "id": 5555555555555555,
      "name": "Example Company s.r.o.",
      "ico": "12345678",
      "dic": "CZ12345678",
      "address": {
        "street": "Hlavn√≠ 123",
        "city": "Praha",
        "postal_code": "11000",
        "country": "CZ"
      },
      "devices_count": 5,
      "users_count": 12
    },
    "permissions": [
      {
        "id": 1111111111111111,
        "slug": "view_monitoring",
        "name": "View Monitoring",
        "description": "Can view monitoring data",
        "category": "monitoring",
        "scope": "read"
      },
      {
        "id": 2222222222222222,
        "slug": "manage_devices",
        "name": "Manage Devices",
        "description": "Can manage device settings",
        "category": "devices",
        "scope": "write"
      }
    ],
    "role": {
      "id": 7777777777777777,
      "name": "Device Manager",
      "slug": "device_manager",
      "description": "Can manage devices and view reports",
      "is_system": false,
      "permissions_count": 8
    },
    "devices": [
      {
        "id": "000C1234567890AB",
        "name": "Nab√≠jec√≠ stanice - Hlavn√≠ budova",
        "product": "MyBox Blue",
        "status": "online",
        "access_level": "full"
      },
      {
        "id": "000C9876543210CD",
        "name": "Nab√≠jec√≠ stanice - Parking",
        "product": "MyBox Pro",
        "status": "online",
        "access_level": "read"
      }
    ],
    "activity": {
      "last_action": "device_configuration_changed",
      "last_action_date": "2024-03-24T16:30:00Z",
      "actions_last_30_days": 156,
      "most_used_feature": "monitoring"
    },
    "settings": {
      "notifications_enabled": true,
      "notification_channels": ["email", "sms"],
      "language": "cs",
      "timezone": "Europe/Prague",
      "two_factor_enabled": false
    },
    "status": "active",
    "created_at": "2024-01-15T10:30:00Z",
    "created_by": {
      "id": 8888888888888888,
      "name": "Admin User",
      "email": "admin@example.com"
    },
    "updated_at": "2024-03-20T14:25:00Z",
    "expires_at": null,
    "notes": "Hlavn√≠ technik pro spr√°vu nab√≠jec√≠ch stanic"
  }
}
```

### P≈ô√≠klad vol√°n√≠

#### cURL
```bash
curl -X GET "https://cloud.mybox.pro/admin-panel/v1/external/user/1234567890123456/participant/9876543210987654" \
  -u "YOUR_API_KEY:YOUR_API_SECRET" \
  -H "Accept: application/json"
```

---

## <Key size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Syst√©m opr√°vnƒõn√≠

### Kategorie opr√°vnƒõn√≠

#### Monitoring
| Permission | Popis |
|------------|-------|
| `view_monitoring` | Zobrazen√≠ live dat a telemetrie |
| `view_history` | Zobrazen√≠ historick√Ωch dat |
| `export_data` | Export dat do CSV/Excel |

#### Devices
| Permission | Popis |
|------------|-------|
| `view_devices` | Zobrazen√≠ seznamu za≈ô√≠zen√≠ |
| `manage_devices` | Zmƒõna nastaven√≠ za≈ô√≠zen√≠ |
| `control_charging` | Start/stop nab√≠jen√≠ |
| `firmware_update` | Aktualizace firmware |

#### Reports
| Permission | Popis |
|------------|-------|
| `view_reports` | Zobrazen√≠ report≈Ø |
| `create_reports` | Vytv√°≈ôen√≠ vlastn√≠ch report≈Ø |
| `export_reports` | Export report≈Ø |

#### Users
| Permission | Popis |
|------------|-------|
| `view_users` | Zobrazen√≠ u≈æivatel≈Ø |
| `manage_users` | Spr√°va u≈æivatel≈Ø |
| `manage_participants` | Spr√°va √∫ƒçastn√≠k≈Ø |

#### Company
| Permission | Popis |
|------------|-------|
| `view_company` | Zobrazen√≠ informac√≠ o spoleƒçnosti |
| `manage_company` | Editace √∫daj≈Ø spoleƒçnosti |
| `billing_access` | P≈ô√≠stup k fakturaci |

---

## <BarChart3 size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Pokroƒçil√© pou≈æit√≠

### Spr√°va opr√°vnƒõn√≠ podle za≈ô√≠zen√≠
```python
def get_user_device_permissions(user_id):
    """Z√≠sk√° p≈ôehled opr√°vnƒõn√≠ u≈æivatele podle za≈ô√≠zen√≠"""

    # Z√≠skat √∫ƒçastn√≠ky
    participants = get_user_participants(user_id)

    device_permissions = {}

    for participant in participants:
        company = participant['company']['name']

        # Pro ka≈æd√© za≈ô√≠zen√≠ v participant datech
        for device in participant.get('devices', []):
            device_id = device['id']

            if device_id not in device_permissions:
                device_permissions[device_id] = {
                    'device_name': device['name'],
                    'companies': [],
                    'permissions': set(),
                    'access_levels': []
                }

            device_permissions[device_id]['companies'].append(company)
            device_permissions[device_id]['access_levels'].append(device['access_level'])

            # P≈ôidat opr√°vnƒõn√≠
            for perm in participant['permissions']:
                device_permissions[device_id]['permissions'].add(perm['slug'])

    return device_permissions
```

### Validace p≈ô√≠stupov√Ωch pr√°v
```javascript
class AccessValidator {
  constructor(apiKey, apiSecret) {
    this.apiKey = apiKey;
    this.apiSecret = apiSecret;
  }

  async canUserAccessDevice(userId, deviceId, requiredPermission) {
    // Z√≠skat √∫ƒçastn√≠ky u≈æivatele
    const participants = await this.getUserParticipants(userId);

    for (const participant of participants) {
      // Zkontrolovat, zda m√° p≈ô√≠stup k za≈ô√≠zen√≠
      const hasDevice = participant.devices?.some(d => d.id === deviceId);

      if (hasDevice) {
        // Zkontrolovat opr√°vnƒõn√≠
        const hasPermission = participant.permissions.some(
          p => p.slug === requiredPermission
        );

        if (hasPermission) {
          return {
            allowed: true,
            company: participant.company.name,
            role: participant.role?.name
          };
        }
      }
    }

    return {
      allowed: false,
      reason: 'No access or missing permission'
    };
  }

  async getUserPermissionMatrix(userId) {
    const participants = await this.getUserParticipants(userId);
    const matrix = {};

    participants.forEach(participant => {
      const companyId = participant.company.id;

      matrix[companyId] = {
        company: participant.company.name,
        role: participant.role?.name || 'Custom',
        permissions: participant.permissions.map(p => p.slug),
        devices: participant.devices?.map(d => ({
          id: d.id,
          name: d.name,
          access: d.access_level
        })) || []
      };
    });

    return matrix;
  }
}
```

### Audit p≈ô√≠stup≈Ø
```python
from datetime import datetime, timedelta
import pandas as pd

def audit_participant_access(company_id, days_back=30):
    """Vytvo≈ô√≠ audit report p≈ô√≠stup≈Ø za obdob√≠"""

    # Z√≠skat v≈°echny √∫ƒçastn√≠ky spoleƒçnosti
    participants = get_company_participants(company_id)

    audit_data = []

    for participant in participants:
        # Z√°kladn√≠ informace
        record = {
            'participant_id': participant['id'],
            'user_email': participant['user']['email'],
            'user_name': f"{participant['user']['first_name']} {participant['user']['last_name']}",
            'status': participant['status'],
            'role': participant.get('role', {}).get('name', 'No role'),
            'created_at': participant['created_at'],
            'last_activity': participant.get('activity', {}).get('last_action_date'),
            'permissions_count': len(participant['permissions']),
            'devices_access_count': len(participant.get('devices', []))
        }

        # Kontrola expirace
        if participant.get('expires_at'):
            expires = datetime.fromisoformat(participant['expires_at'].replace('Z', '+00:00'))
            record['expires_in_days'] = (expires - datetime.now()).days
            record['is_expiring_soon'] = record['expires_in_days'] < 30
        else:
            record['expires_in_days'] = None
            record['is_expiring_soon'] = False

        # Aktivita
        if participant.get('activity'):
            record['actions_last_30_days'] = participant['activity'].get('actions_last_30_days', 0)
            record['is_active'] = record['actions_last_30_days'] > 0
        else:
            record['actions_last_30_days'] = 0
            record['is_active'] = False

        # Kritick√° opr√°vnƒõn√≠
        critical_permissions = ['manage_devices', 'firmware_update', 'manage_users', 'billing_access']
        user_critical_perms = [
            p['slug'] for p in participant['permissions']
            if p['slug'] in critical_permissions
        ]
        record['has_critical_permissions'] = len(user_critical_perms) > 0
        record['critical_permissions'] = ', '.join(user_critical_perms)

        audit_data.append(record)

    # Vytvo≈ôit DataFrame
    df = pd.DataFrame(audit_data)

    # Anal√Ωza
    print("üìä AUDIT REPORT - P≈ô√≠stupy √∫ƒçastn√≠k≈Ø")
    print("=" * 60)
    print(f"Celkem √∫ƒçastn√≠k≈Ø: {len(df)}")
    print(f"Aktivn√≠: {df['status'].eq('active').sum()}")
    print(f"Suspendovan√≠: {df['status'].eq('suspended').sum()}")
    print(f"ƒåekaj√≠c√≠: {df['status'].eq('pending').sum()}")
    print()

    print("‚ö†Ô∏è Vy≈æaduj√≠ pozornost:")
    print(f"- Brzy expiruj√≠c√≠ p≈ô√≠stupy: {df['is_expiring_soon'].sum()}")
    print(f"- Neaktivn√≠ √∫ƒçastn√≠ci (0 akc√≠ za 30 dn√≠): {(~df['is_active']).sum()}")
    print(f"- √öƒçastn√≠ci s kritick√Ωmi opr√°vnƒõn√≠mi: {df['has_critical_permissions'].sum()}")

    # Export do Excel
    filename = f"audit_participants_{company_id}_{datetime.now().strftime('%Y%m%d')}.xlsx"
    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='Participants', index=False)

        # P≈ôidat souhrn
        summary = pd.DataFrame([
            {'Metrika': 'Celkem √∫ƒçastn√≠k≈Ø', 'Hodnota': len(df)},
            {'Metrika': 'Aktivn√≠ √∫ƒçastn√≠ci', 'Hodnota': df['status'].eq('active').sum()},
            {'Metrika': 'Pr≈Ømƒõrn√Ω poƒçet opr√°vnƒõn√≠', 'Hodnota': df['permissions_count'].mean()},
            {'Metrika': '√öƒçastn√≠ci s kritick√Ωmi opr√°vnƒõn√≠mi', 'Hodnota': df['has_critical_permissions'].sum()}
        ])
        summary.to_excel(writer, sheet_name='Summary', index=False)

    print(f"\n‚úÖ Report exportov√°n: {filename}")

    return df
```

---

## <AlertTriangle size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Chybov√© stavy

### Mo≈æn√© chybov√© odpovƒõdi

#### 401 Unauthorized
```json
{
  "status": 0,
  "error": "Unauthorized",
  "message": "Invalid API credentials"
}
```

#### 403 Forbidden
```json
{
  "status": 0,
  "error": "Forbidden",
  "message": "Insufficient permissions to view participants"
}
```

#### 404 Not Found
```json
{
  "status": 0,
  "error": "Not Found",
  "message": "Participant not found"
}
```

---

## <Lightbulb size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Best Practices

### 1. Cachov√°n√≠ participant dat
```python
from functools import lru_cache
import time

class ParticipantCache:
    def __init__(self, ttl=300):  # 5 minut cache
        self.cache = {}
        self.ttl = ttl

    def get_participant(self, user_id, participant_id):
        cache_key = f"{user_id}:{participant_id}"

        if cache_key in self.cache:
            cached_data, timestamp = self.cache[cache_key]
            if time.time() - timestamp < self.ttl:
                return cached_data

        # Fetch from API
        data = self._fetch_from_api(user_id, participant_id)
        self.cache[cache_key] = (data, time.time())
        return data
```

### 2. Permission checking helper
```javascript
class PermissionChecker {
  constructor(participants) {
    this.participants = participants;
    this.permissionMap = this.buildPermissionMap();
  }

  buildPermissionMap() {
    const map = new Map();

    this.participants.forEach(participant => {
      participant.permissions.forEach(perm => {
        if (!map.has(perm.slug)) {
          map.set(perm.slug, []);
        }
        map.get(perm.slug).push({
          participantId: participant.id,
          companyId: participant.company.id,
          companyName: participant.company.name
        });
      });
    });

    return map;
  }

  hasPermission(permissionSlug) {
    return this.permissionMap.has(permissionSlug);
  }

  getCompaniesWithPermission(permissionSlug) {
    const entries = this.permissionMap.get(permissionSlug) || [];
    return [...new Set(entries.map(e => e.companyName))];
  }

  canAccessCompany(companyId) {
    return this.participants.some(p => p.company.id === companyId);
  }
}
```

### 3. Role management
```python
def get_effective_permissions(participant):
    """Z√≠sk√° efektivn√≠ opr√°vnƒõn√≠ (role + custom permissions)"""

    permissions = set()

    # Opr√°vnƒõn√≠ z role
    if participant.get('role'):
        role_permissions = get_role_permissions(participant['role']['id'])
        permissions.update(p['slug'] for p in role_permissions)

    # Explicitn√≠ opr√°vnƒõn√≠
    permissions.update(p['slug'] for p in participant['permissions'])

    # Odebrat revoked permissions
    if participant.get('revoked_permissions'):
        for revoked in participant['revoked_permissions']:
            permissions.discard(revoked['slug'])

    return list(permissions)
```

---

## <BookOpen size={20} style={{display: 'inline', verticalAlign: 'middle', marginRight: '0.5rem'}} color="var(--ifm-color-primary)" /> Dal≈°√≠ zdroje

- [Spr√°va u≈æivatel≈Ø](/api/users-management) - API pro pr√°ci s u≈æivateli
- [Spr√°va spoleƒçnost√≠](/api/companies-management) - API pro pr√°ci se spoleƒçnostmi
- [Spr√°va za≈ô√≠zen√≠](/api/devices) - Informace o za≈ô√≠zen√≠ch
- [FAQ - ƒåast√© dotazy](/faq#participants) - Odpovƒõdi na ƒçast√© dotazy o √∫ƒçastn√≠c√≠ch